<!DOCTYPE html>
<html>
    <head>
        <title>Warehouse Management</title>
        <link rel="stylesheet" href="style/styles.css">
        <script type="text/javascript" src="https://code.jquery.com/jquery-2.2.4.js"></script>
        <script type="text/javascript">
          /*function save(id){
            alert("Saved: "+id);
            //window.location.href("updatepurchase.php?id="+id);
          }*/

          $(document).ready(function(){

              /*$('#sv1').click(function(){
                alert("saved");
              });*/

              $.get("http://localhost/m151/Lagerverwaltung/src/app/check_session.php", function(bool){
                  if(bool == "false"){
                    window.location.replace("http://localhost/m151/Lagerverwaltung/src/app/login.html");
                  }
              });


              $.getJSON("http://localhost/m151/Lagerverwaltung/src/app/getpurchases.php", function(arr){
                var bestnr = [];
                var status = [];

                for(var i=0; i<arr.length; i++){
                    $("#purchases").append("<tr><td>"+arr[i].bestellnr+"</td>"+
                    "<td>"+arr[i].datum+"</td><td>"+arr[i].titel+"</td>"+
                    "<td>"+arr[i].fk_erfasser+"</td>"+
                    "<td><input type='number' id='anz"+arr[i].bestellnr+"' name='anzahl' value='"+arr[i].anzahl+"'></td>"+
                    "<td><select id='status"+arr[i].bestellnr+"' >"+
                    "</select></td>"+
                    "<td><input type='text' id='cmt"+arr[i].bestellnr+"' name='kommentar' value='"+arr[i].kommentar+"'></td>"+
                    "<td><input type='button' id='sv-"+arr[i].bestellnr+"-"+arr[i].fk_produkt+"' class='save' value='Save'></td>"+
                    "</tr>");

                    bestnr.push(arr[i].bestellnr);
                    status.push(arr[i].fk_status);




                }

                $.getJSON("http://localhost/m151/Lagerverwaltung/src/app/getstatus.php", function(sts){

                  //alert(bestnr.length);

                  for(var i=0; i<bestnr.length; i++){
                    var bestid = bestnr[i];
                    var fk_status = status[i];

                    for(var j=0; j<sts.length; j++){
                      var selected = "";
                      var read = "";
                      if(sts[j].id_status == fk_status){
                        selected = "selected";
                      }



                      //alert(bestnr);
                      //alert(fk_status);

                      $("#status"+bestid).append("<option value='"+sts[j].id_status+"' "+selected+" >"+sts[j].status+"</option>");

                      if(fk_status > 1){
                        //alert("READONLY");
                        $("#anz"+bestid).prop("disabled", true);
                        $("#status"+bestid).prop("disabled", true);
                      }
                    }

                  }
                });

              });




          });


          $(document).on('click', '.save', function(){
            var id = $(this).attr('id').split('-');
            var cmt = $('#cmt'+id[1]).val();
            var anz = $('#anz'+id[1]).val();
            var status = $('#status'+id[1]).val();
            var st1 = false;
            var st2 = false;
            var menge = 0;
            var neuemenge = 0;
            var currentstatus = 0;

            //alert(id[2]);

            $.getJSON("http://localhost/m151/Lagerverwaltung/src/app/getlager.php", {idb:id[2]}, function(lgr){
              menge = lgr[0].menge;
              neuemenge = menge;
              if(status>1){
                st1 = true;
              }
              //alert(menge);
              $.getJSON("http://localhost/m151/Lagerverwaltung/src/app/getcurrentstatus.php", {ids:id[1]}, function(crs){


                alert(crs[0].fk_status);
                if(crs[0].fk_status == 1){
                  st2 = true;
                }

                if(st1 && st2){
                  neuemenge = menge-anz;
                  alert("SUBTRAKTION")
                }
                //alert(neuemenge);

                if(neuemenge >= 0){
                  $.get("http://localhost/m151/Lagerverwaltung/src/app/updatepurchase.php", {bestellnr:id[1], com:cmt, an:anz, sts:status}, function(ret){

                    alert(ret);

                    if($('#status'+id[1]).val()>1){


                      $("#status"+id[1]).prop("disabled", true);
                    }
                  });

                  $.get("http://localhost/m151/Lagerverwaltung/src/app/updatequantity.php", {nm:neuemenge, idq:id[2]}, function(qty){
                    alert(qty);
                  });
                }else{
                  alert("Zu wenig Artikel im Lager!");
                }


              });
            });

            //alert(menge);



          });
        </script>
    </head>
    <body>

        <table id="purchases">
          <tr>
              <th>Bestellnummer</th>
              <th>Datum</th>
              <th>Produkt</th>
              <th>Erfasser</th>
              <th>Anzahl</th>
              <th>Status</th>
              <th>Kommentar</th>


          </tr>
        </table>

        <a href="addpurchase.html" class="smallbutton">Neue Bestellung</a>
        <a href="logout.php" class="smallbutton">Logout</a>

</body>
</html>
